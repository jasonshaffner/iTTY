#!/home/jasonshaffner/dev3/anacalypsis/env/bin/python3

import getpass, sys, threading, re
from iTTY.mpcommandthread import Mpcommand
from format import Format

if len(sys.argv) < 5:
        username = input("Username: ")
        password = getpass.getpass()
        devicelist = input("Device list file: ")
else:
        username = sys.argv[1]
        password = sys.argv[2]
        devicelist = sys.argv[3]
hostnames = open(devicelist, 'r')
command_delay = 1
threadcount = 1000
ios = ['terminal length 0', 'show ipv6 int brie | ex down|unassigned']
xr = ['terminal length 0', 'show ipv6 int brie | utility egrep "down\|unassigned" -v']
junos = ['set cli screen-length 0', 'show interfaces terse | match inet']
alu = ['environment no more', 'show router interface ipv6']

pool = threading.Semaphore(threadcount)
threads = []
for host in hostnames:
	thread = Mpcommand(username, password, host.split('.')[0].strip(), command_delay, pool=pool, \
		ioscommands=ios, xrcommands=xr, junoscommands=junos, alucommands=alu, commandheader=0)
	threads.append(thread)
	thread.start()
report = [["Hostname", "Interface", "IPv6 Address"],]
for t in threads: 
        t.join()
	interface = ''
	address = ''
	linklocal = re.compile(' FE80', re.I)
        try:
		output = t.tty.getoutput()
		for line in output:
			if not re.match(r'\s', line): interface = line.split()[0].strip()
			elif re.search(linklocal, line): continue
			elif re.search('IP-Address', line): continue
			elif re.search(' - ', line): continue
			else: 
				if t.tty.os == 1: address = line.strip().split()[0]
				else: address = line.split()[-1].strip()
				report.append([t.host, interface, address])
        except:
                print("No data available for " + t.host.strip())
hostnames.close()
report = sorted(report, key=lambda hostname: hostname[0])
print(Format.columnize(report, bars=1, width=5))
